### A VRF+Enclave Random Number Generator for smartBCH

The dev team of smartBCH implements and maintains the service of a manipulation-proof random number generator. As we have [described](https://read.cash/@SmartBCH/light-weighted-manipulation-proof-random-number-generator-for-smartbch-79ac7d36), it is based on the VRF+Enclave mechanism. This document describes how to get the random numbers (VRF outputs of block hashes) from the RPC server, and how to verify them with the governance contract.

On the RPC server, two processes are running: an enclaved process keeping the VRF private key and a non-enclave proxy process. The proxy process inputs block hashes to the enclaved process and then caches its outputs. The proxy process can access larger DRAM space, so it interacts with the clients. And the attestation requests sent to the enclaved process are forwarded by the proxy process.

Now there are two RPC servers, enclave0.vrf.cash and enclave1.vrf.cash, are serving random numbers at port 8081. They have identical functionality. You can access their following RPC endpoints:

#### `/vrf?b=<blockhash>`

Given a block hash, it returns the corresponding VRF output, i.e., the manipulation-proof random number, as well as the output's proof. Please note the block hash is in hex format and does not have a "0x" prefix. 

The returned value is a JSON object, with a `PI` field as the proof and a `Beta` field as the random number, for example:

```json
{"PI":"0293ffbc72c227c3b3187b875ab92d466fadc2c2ad82c7462d85ae14d8c2ad047cb3258ec359ce21e30c25f327d5b693a2e8d785f9f522cdf7d66ec56f7de9ab848466fea0ac33e4d539f37bcd6993d5d2","Beta":"4674ab45ef18d900d6c4ca25e3faec40271e856efed3ec899d91fff08896e630"}
```

#### `/pubkey`

Returns the corresponding public key of the VRF private key kept by the enclave. It is a 33-byte hex string.

#### `/report`

The attestation report generated by the enclave

#### `/token`

A JWT token issued by Azure which endorses the enclave's attestation report.

On smartBCH mainnet, the governance contract is deployed at 0x18C51aa3d1F018814716eC2c7C41A20d4FAf023C. It provides two functions for DApp developers:

```solidity
function pubKey() public returns (bytes);
function verify(uint blockHash, uint beta, bytes calldata pi) public view returns (bool);
```

The `pubKey` function returns the endorsed VRF public key. A quorum of operators checks the `/pubkey` RPC's result and endorses the pubkey store in this governance contract.

The `verify` function takes the `blockHash` input, the VRF output `beta`, and the proof `pi`, and returns whether `beta` is valid according to `pi`.


